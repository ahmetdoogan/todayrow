"use client";

import React, { useEffect, useState } from "react";
import { useSearchParams } from "next/navigation";
import PlannerHeader from "@/components/planner/PlannerHeader";
import PlanList from "@/components/planner/PlanList";
import QuickPlans from "@/components/planner/QuickPlans";
import { usePlanner } from "@/context/PlannerContext";
import { useRouter } from "next/navigation";
import { ListPlus } from "lucide-react";

export default function PlannerPage() {
  const searchParams = useSearchParams();
  const { plans, setSelectedPlan, setIsModalOpen } = usePlanner();
  const [isQuickPlansOpen, setIsQuickPlansOpen] = useState(false);

  const router = useRouter();

  useEffect(() => {
    const openPlanId = searchParams.get("openPlan");
    if (openPlanId) {
      const planToOpen = plans.find(
        (plan) => plan.id === parseInt(openPlanId)
      );
      if (planToOpen) {
        setSelectedPlan(planToOpen);
        setIsModalOpen(true);
        router.replace("/dashboard/planner");
      }
    }
  }, [searchParams, plans]);

  return (
    <div className="h-full flex flex-col relative">
      <PlannerHeader />

      <div className="flex-1 overflow-hidden">
        <div className="w-full h-full overflow-y-auto">
          <PlanList />
        </div>

        <div className="hidden md:block fixed right-0 top-0 bottom-0 w-64 xl:w-72 
                      border-l border-gray-200 dark:border-gray-800
                      bg-white dark:bg-gray-800">
          <QuickPlans />
        </div>
      </div>

      <div className="md:hidden">
        <button
          onClick={() => setIsQuickPlansOpen(true)}
          className="fixed right-4 bottom-20 z-[1000] w-14 h-14
                   bg-blue-600 hover:bg-blue-700 text-white rounded-full
                   shadow-lg hover:shadow-xl flex items-center justify-center
                   transition-all duration-200 dark:bg-blue-500 dark:hover:bg-blue-600"
        >
          <ListPlus size={24} />
        </button>
      </div>

      {isQuickPlansOpen && (
        <div
          className="fixed md:hidden inset-0 bg-black/50 backdrop-blur-sm flex items-end z-[1000]"
          onClick={(e) => {
            if (e.target === e.currentTarget) setIsQuickPlansOpen(false);
          }}
        >
          <div
            className="w-full bg-white dark:bg-gray-800 rounded-t-2xl
                     max-h-[80vh] overflow-auto
                     animate-in slide-in-from-bottom duration-300"
          >
            <QuickPlans onClose={() => setIsQuickPlansOpen(false)} />
          </div>
        </div>
      )}
    </div>
  );
}